From: =?UTF-8?q?Leonard=20G=C3=B6hrs?= <l.goehrs@pengutronix.de>
Date: Fri, 6 May 2022 11:53:05 +0200
Subject: [PATCH] ARM: dts: stm32: Update to the new and improved power board
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The new Power Board includes an isolated SPI-ADC in the Device under Test
power domain, an optional temperature sensor and a button.
Perform the required devicetree changes.

Signed-off-by: Leonard GÃ¶hrs <l.goehrs@pengutronix.de>
---
 arch/arm/boot/dts/stm32mp157c-lxa-tac.dts | 64 +++++++++++++++++++++----------
 1 file changed, 44 insertions(+), 20 deletions(-)

diff --git a/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts b/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts
index 2e032af8c1ab..2d48bf42a6b9 100644
--- a/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts
+++ b/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts
@@ -74,11 +74,17 @@ led-4 {
 	gpio-keys {
 		compatible = "gpio-keys";
 
-		user-button {
+		user-button1 {
 			label = "USER_BTN";
 			linux,code = <KEY_HOME>;
 			gpios = <&gpioi 11 GPIO_ACTIVE_LOW>;
 		};
+
+		user-button2 {
+			label = "USER_BTN2";
+			linux,code = <KEY_ESC>;
+			gpios = <&gpioe 7 GPIO_ACTIVE_LOW>;
+		};
 	};
 
 	/* supplied by either barrel connector or PoE */
@@ -230,10 +236,6 @@ channel@5 {
 			reg = <5>;
 			label = "IOBUS_CURR_FB";
 		};
-		channel@6 {
-			reg = <6>;
-			label = "PWR_U_VCC"; /* via STACK_SPI_CS0 to Power Switch Board */
-		};
 		channel@9 {
 			reg = <9>;
 			label = "IOBUS_VOLT_FB";
@@ -242,18 +244,10 @@ channel10 {
 			reg = <10>;
 			label = "OUT_1_FB";
 		};
-		channel@11 {
-			reg = <11>;
-			label = "PWR_U_GND"; /* via STACK_SPI_CS1 to Power Switch Board */
-		};
 		channel@13 {
 			reg = <13>;
 			label = "HOST_CURR_FB";
 		};
-		channel@14 {
-			reg = <14>;
-			label = "PWR_I"; /* via STACK_SPI_CS2 to Power Switch Board */
-		};
 		channel@15 {
 			reg = <15>;
 			label = "HOST_1_CURR_FB";
@@ -413,7 +407,7 @@ &i2c1 {
 	pinctrl-1 = <&i2c1_sleep_pins_b>;
 	status = "okay";
 
-	gpio@48 {
+	pwr_gpio: pca9570@48 {
 		compatible = "nxp,pca9570";
 		reg = <0x24>;
 		gpio-controller;
@@ -422,11 +416,17 @@ gpio@48 {
 		status = "okay";
 	};
 
-	eeprom@50 {
+	pwr_eeprom@50 {
 		compatible = "atmel,24c02";
 		reg = <0x50>;
 		vcc-supply = <&v3v3>;
 	};
+
+	lm75ad@48 {
+		compatible = "national,lm75a";
+		reg = <0x48>;
+		status = "disabled";
+	};
 };
 
 &i2c5 {
@@ -444,6 +444,21 @@ usbhub: usbhub@2c {
 	};
 };
 
+&spi2 {
+	pinctrl-names = "default";
+	pinctrl-0 = <&spi2_pins_b>;
+	cs-gpios = <&gpiof 12 GPIO_ACTIVE_LOW>;
+	status = "okay";
+
+	lmp92064@0 {
+		compatible = "ti,lmp92064";
+		reg = <0>;
+		spi-max-frequency = <5000000>;
+		reset-gpios = <&pwr_gpio 2 GPIO_ACTIVE_HIGH>;
+		shunt-resistor = <15000>;
+	};
+};
+
 &spi5 {
 	/* spare dmas for other usage */
 	/delete-property/dmas;
@@ -561,14 +576,10 @@ adc1_ain_pins_a: adc1-ain-0 {
 		pins {
 			pinmux = <STM32_PINMUX('F', 11, ANALOG)>, /* ADC1_INP2 */
 				 <STM32_PINMUX('B', 1, ANALOG)>, /* ADC1_INP5 */
-				 <STM32_PINMUX('F', 12, ANALOG)>, /* ADC1_INP6 */
 				 <STM32_PINMUX('B', 0, ANALOG)>, /* ADC1_INP9 */
 				 <STM32_PINMUX('C', 0, ANALOG)>, /* ADC1_INP10 */
-				 <STM32_PINMUX('C', 1, ANALOG)>, /* ADC1_INP11 */
 				 <STM32_PINMUX('C', 3, ANALOG)>, /* ADC1_INP13 */
-				 <STM32_PINMUX('A', 2, ANALOG)>, /* ADC1_INP14 */
-				 <STM32_PINMUX('A', 3, ANALOG)>, /* ADC1_INP15 */
-				 <STM32_PINMUX('A', 4, ANALOG)>; /* ADC1_INP18 */
+				 <STM32_PINMUX('A', 3, ANALOG)>; /* ADC1_INP15 */
 		};
 	};
 	ethernet0_rgmii_pins_d: rgmii-1 {
@@ -609,6 +620,19 @@ pins1 {
 				 <STM32_PINMUX('A', 7, ANALOG)>; /* ETH_RGMII_RX_CTL */
 		 };
 	};
+	spi2_pins_b: spi2-1 {
+		pins1 {
+			pinmux = <STM32_PINMUX('I', 1, AF5)>, /* SPI2_SCK */
+			<STM32_PINMUX('I', 3, AF5)>; /* SPI2_MOSI */
+			bias-disable;
+			drive-push-pull;
+		};
+
+		pins2 {
+			pinmux = <STM32_PINMUX('I', 2, AF5)>; /* SPI2_MISO */
+			bias-pull-down;
+		};
+	};
 	spi5_pins_a: spi5-0 {
 		pins1 {
 			pinmux = <STM32_PINMUX('F', 7, AF5)>, /* SPI5_SCK */
