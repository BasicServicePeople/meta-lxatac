From: =?UTF-8?q?Leonard=20G=C3=B6hrs?= <l.goehrs@pengutronix.de>
Date: Mon, 11 Oct 2021 16:10:55 +0200
Subject: [PATCH] ARM: dts: stm32: make the voltage regulator hierarchy match
 the LXATAC PCB
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The LXATAC devicetree is based on stm32mp157c-lxa-mc1.dts.
The relevant parts of the MC1 voltage regulator chain is as follow:

--+ 48V (via PoE)
  +-+ 5V (via PoE controller)
    +-+ 3.3V (via fixed regulator)
    | +- On-Board peripherals
    |
    +-+ 3.3V (via PMIC)
      +- SoC supply

The LXATAC has a different voltage regulator chain:

--+ 48V (via PoE)
  +-+ 12V (via PoE controller or barrel jack)
    +-+ 5V (via fixed regulator)
      +-+ 3.3V (via PMIC)
      | +- SoC supply
      | +- On-Board peripherals
      |
      +-+ 1.2V (via fixed regulator)
        +- Ethernet Phy/Switch

E.g. there is no fixed 3.3V regulator anymore, as the PMIC is used now
to supply the On-Board peripherals. There is however a new additional
regulator step to generate 5V from PoE.

This commit reflects these differences in the hardware design.

Signed-off-by: Leonard GÃ¶hrs <l.goehrs@pengutronix.de>
---
 arch/arm/boot/dts/stm32mp157c-lxa-tac.dts | 33 +++++++++++++++++++++----------
 1 file changed, 23 insertions(+), 10 deletions(-)

diff --git a/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts b/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts
index 456cdd7d0be7..5171bb1e5037 100644
--- a/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts
+++ b/arch/arm/boot/dts/stm32mp157c-lxa-tac.dts
@@ -56,33 +56,33 @@ user-button {
 		};
 	};
 
-	reg_3v3: regulator_3v3 {
+	/* supplied by either barrel connector or PoE */
+	reg_12v: regulator_12v {
 		compatible = "regulator-fixed";
-		regulator-name = "3V3";
-		regulator-min-microvolt = <3300000>;
-		regulator-max-microvolt = <3300000>;
+		regulator-name = "12V";
+		regulator-min-microvolt = <12000000>;
+		regulator-max-microvolt = <12000000>;
 		regulator-always-on;
-		vin-supply = <&v3v3>;
 	};
 
-	/* supplied by either debug board or PoE */
 	reg_5v: regulator_5v {
 		compatible = "regulator-fixed";
-		regulator-name = "BRINGUP_5V";
+		regulator-name = "5V";
 		regulator-min-microvolt = <5000000>;
 		regulator-max-microvolt = <5000000>;
 		regulator-always-on;
+		vin-supply = <&reg_12v>;
 	};
 
 	reg_1v2: regulator_1v2 {
 		compatible = "regulator-fixed";
-		regulator-name = "BRINGUP_1V2";
+		regulator-name = "1V2";
 		regulator-min-microvolt = <1200000>;
 		regulator-max-microvolt = <1200000>;
 		regulator-always-on;
+		vin-supply = <&reg_5v>;
 	};
 
-
 	iobus_curr: current-sense-amplifier@0 {
 		compatible = "current-sense-amplifier";
 		io-channels = <&adc1 5>;
@@ -153,6 +153,11 @@ usb {
 	};
 };
 
+&pwr_regulators {
+	vdd-supply = <&vdd>;
+	vdd_3v3_usbfs-supply = <&vdd_usb>;
+};
+
 &hash1 {
 	status = "okay";
 };
@@ -319,9 +324,14 @@ &gpu {
 
 &pmic {
 	regulators {
+		buck1-supply = <&reg_5v>;	/* VIN */
+		buck2-supply = <&reg_5v>;	/* VIN */
+		buck3-supply = <&reg_5v>;	/* VIN */
 		buck4-supply = <&reg_5v>;	/* VIN */
 		ldo2-supply = <&reg_5v>;	/* PMIC_LDO25IN */
+		ldo4-supply = <&reg_5v>;	/* VIN */
 		ldo5-supply = <&reg_5v>;	/* PMIC_LDO25IN */
+		vref_ddr-supply = <&reg_5v>;	/* VIN */
 		boost-supply = <&reg_5v>;	/* PMIC_BSTIN */
 		pwr_sw2-supply = <&bst_out>;	/* PMIC_SWIN */
 	};
@@ -339,7 +349,7 @@ &sdmmc2 {
 	no-sdio;
 	non-removable;
 	st,neg-edge;
-	vmmc-supply = <&reg_3v3>;
+	vmmc-supply = <&v3v3>;
 	status = "okay";
 };
 
@@ -385,6 +395,7 @@ gpio@48 {
 	eeprom@50 {
 		compatible = "atmel,24c02";
 		reg = <0x50>;
+		vcc-supply = <&v3v3>;
 	};
 };
 
@@ -451,6 +462,8 @@ fixed-link {
 &usbotg_hs {
 	phys = <&usbphyc_port1 0>;
 	phy-names = "usb2-phy";
+	vusb_d-supply = <&vdd_usb>;
+	vusb_a-supply = <&reg18>;
 	status = "okay";
 };
 
